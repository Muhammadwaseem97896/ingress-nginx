{{- if .Values.enabled -}}
  {{- if semverCompare ">=1.19-0" .Capabilities.KubeVersion.GitVersion -}}
apiVersion: networking.k8s.io/v1
  {{- else -}}
apiVersion: networking.k8s.io/v1beta1
  {{- end }}
kind: Ingress
metadata:
  name: {{ include "ingress.name" . }}
  {{- if .Values.namespace }}
  namespace: {{ .Values.namespace }}
  {{- end}}
  labels:
  {{- with .Values.labels }}
  {{- toYaml . | nindent 4 }}
  {{- end }}
{{ include "ingress.labels" . | indent 4 }}
  annotations:
  {{- if eq .Values.type "alb" }}
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: {{ .Values.alb.scheme }}
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
    alb.ingress.kubernetes.io/target-type: {{ .Values.alb.targetType }}
    alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=300,access_logs.s3.enabled=true,access_logs.s3.bucket={{ .Values.environment.name }}-alb-access-logs
    alb.ingress.kubernetes.io/tags: fwm-managed=true, fwm-policy=full
    nginx.ingress.kubernetes.io/proxy-connect-timeout: {{ .Values.alb.connectTimeout | quote }}
    nginx.ingress.kubernetes.io/proxy-read-timeout: {{ .Values.alb.requestTimeout | quote }}
    nginx.ingress.kubernetes.io/proxy-send-timeout: {{ .Values.alb.requestTimeout | quote }}
    alb.ingress.kubernetes.io/ssl-policy:  {{ .Values.alb.sslPolicy }}
  {{- if .Values.alb.certificateArn }}
    alb.ingress.kubernetes.io/certificate-arn: {{ .Values.alb.certificateArn }}
  {{- end }}
  {{- if .Values.fullName }}
    external-dns.alpha.kubernetes.io/hostname: {{ .Values.fullName | quote}}
  {{- end }}
  {{- if .Values.alb.healthcheckPath }}
    alb.ingress.kubernetes.io/healthcheck-path: {{ .Values.alb.healthcheckPath }}
  {{- end }}
  {{- else if eq .Values.type "nginx"}}
    kubernetes.io/ingress.class: "nginx"
  {{- end }}
spec:
  rules:
    - http:
        paths:
          {{- if eq .Values.type "alb" }}
          - path: /*
            backend:
              serviceName: ssl-redirect
              servicePort: use-annotation
          - path: {{ .Values.alb.path }}
          {{- else if eq .Values.type "nginx"}}
          - path: {{ .Values.nginx.path }}
          {{- end }}
          backend:
            serviceName: {{ template "ingress.service.name" . }}
            servicePort: {{ .Values.service.port }}
  {{- end }}
